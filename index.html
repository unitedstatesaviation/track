<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="USAA.shield.svg">
    <title>USAA Track</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root{font-family:'Poppins',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;margin:0}
            body{background:linear-gradient(135deg,#ffffff 0%,#f5f7fa 50%,#e8ecf1 100%);color:#000000;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:24px}
      .card{background:white;border:1px solid rgba(10,49,97,0.1);border-radius:12px;padding:30px;max-width:1400px;width:100%;box-shadow:0 10px 40px rgba(10,49,97,0.15)}
      h1{margin:0 0 10px;font-size:1.8em;font-weight:600;color:#0A3161;line-height:1.3}
      p.lead{margin:0 0 16px;color:#495057;font-size:1em;line-height:1.6}
      .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
      button{background:#0A3161;color:white;border:0;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;transition:all 0.3s ease;font-family:'Poppins',sans-serif}
      button:hover{background:#0d4080;transform:translateY(-1px);box-shadow:0 4px 8px rgba(10,49,97,0.2)}
      button[disabled]{opacity:0.6;cursor:not-allowed;transform:none}
      .muted{color:#6c757d;font-size:13px}
  ul.list{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
  li.item{background:white;padding:20px;border-radius:8px;border:1px solid rgba(10,49,97,0.1);display:flex;align-items:center;gap:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:all 0.3s ease}
  li.item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .left{flex:1;display:flex;flex-direction:column;gap:6px}
  .left .radio{font-size:16px;font-weight:600;color:#0A3161}
  .left .facility{font-size:14px;color:#495057;font-weight:400}
    .left .realname{font-size:14px;color:#6c757d;font-weight:400}
  .role-badge{display:inline-block;margin-left:8px;padding:4px 8px;background:#0A3161;border-radius:4px;color:white;font-weight:500;font-size:12px}
  li.item.observer{opacity:0.55;font-style:italic}
  li.item.event{background:linear-gradient(135deg,#B31942 0%,#8f1435 100%);border:2px solid #B31942;margin-bottom:12px;grid-column:1 / -1;display:flex;flex-direction:column;color:white}
  li.item.event .radio{color:white;font-size:18px;font-weight:600}
  li.item.event .freq{color:white;font-size:20px;font-weight:600}
  li.item.event .facility{color:white}
  li.item.event .callsign-small{color:rgba(255,255,255,0.9)}
  li.item.event .role-badge{background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3)}
  .event-image{width:100%;height:auto;object-fit:cover;display:block;margin-bottom:12px;min-height:200px}
  .event-content{display:flex;justify-content:space-between;align-items:flex-start;gap:0;padding:0;width:100%}
  .event-content .left{text-align:left;flex:0 0 auto;padding:12px 0 12px 12px}
  .event-content .right{text-align:right;flex:0 0 auto;padding:12px 12px 12px 0}
  .right{width:140px;flex:0 0 140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
  .freq{font-size:18px;font-weight:600;color:#0A3161}
  .callsign-small{font-size:12px;color:#6c757d;font-weight:500}
      .error{color:white;background:#dc3545;padding:10px;border-radius:8px;font-weight:500}
      .loading{color:#0A3161;font-weight:500}
      .apps-menu{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#0A3161 0%,#001f3f 100%);border-bottom:2px solid #B31942;padding:12px 0;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
      .apps-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:20px;padding:0 40px}
      .apps-logo{color:white;font-weight:700;font-size:18px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.3s ease}
      .apps-logo:hover{transform:scale(1.02)}
      .apps-logo img{height:40px;width:auto;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
      .apps-nav{display:flex;gap:16px;margin-left:auto}
      .apps-nav a{color:rgba(255,255,255,0.9);text-decoration:none;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.3s ease}
      .apps-nav a:hover{color:white;background:rgba(255,255,255,0.1);transform:translateY(-1px)}
      .apps-nav a.current{color:white;background:#B31942;font-weight:600}
      body{background:linear-gradient(135deg,#ffffff 0%,#f5f7fa 50%,#e8ecf1 100%);color:#000000;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:24px;padding-top:80px}
      footer{margin-top:24px;font-size:12px;color:#6c757d;text-align:center}
      footer a{color:#0A3161;font-weight:500;text-decoration:none}
      footer a:hover{text-decoration:underline}
      @media (max-width:420px){.card{padding:20px}.apps-container{padding:0 16px}}
    </style>
  </head>
  <body>
    <!-- USAA Apps Menu -->
    <nav class="apps-menu">
      <div class="apps-container">
        <a href="https://unitedstatesaviation.us" class="apps-logo">
          <img src="USAA.white.svg" alt="United States Aviation Logo">
          <span>USAA</span>
        </a>
        <div class="apps-nav">
          <a href="https://unitedstatesaviation.us">Home</a>
        </div>
      </div>
    </nav>

    <main class="card" role="main">
  <h1>USAA - Controllers</h1>
  <p class="lead">Shows USAA controllers connected to the USAA Network.</p>

      <div class="controls">
        <button id="refresh">Refresh</button>
        <div id="status" class="muted">Updated: —</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div id="artccTitle" style="margin-left:auto;font-weight:700;color:#cfe4ff"></div>
      </div>

      <div id="artccTiles" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>

      <div id="message" aria-live="polite"></div>
      <ul id="list" class="list" aria-live="polite"></ul>

  <footer>Data source: <a href="https://usaa-backend.sebpartof2.workers.dev/controllers" target="_blank" rel="noreferrer noopener" style="color:#9fc3ff">USAA API</a></footer>
    </main>

    <script>
  const UPSTREAM_URL = 'https://usaa-backend.sebpartof2.workers.dev/controllers';
  const PROXY_URL = null; // no local proxy needed for USAA API
      const refreshBtn = document.getElementById('refresh');
      const statusEl = document.getElementById('status');
      const listEl = document.getElementById('list');
      const msgEl = document.getElementById('message');

      function showMessage(text, className){
        msgEl.innerHTML = '';
        if(!text) return;
        const div = document.createElement('div');
        div.textContent = text;
        if(className) div.className = className;
        msgEl.appendChild(div);
      }

      // Global variable to store callsigns, airports, artccs, users, and events data
      let callsignsData = {};
      let airportsData = {};
      let artccsData = {};
      let usersData = {};
      let eventsData = {};

      async function loadEventsData(){
        try {
          const response = await fetch('https://usaa-data-api.sebpartof2.workers.dev/api/events', {cache: 'no-store'});
          if (!response.ok) return {};
          const events = await response.json();
          const data = {};
          for (const event of events) {
            const eventId = event.eventId || event.id;
            if (eventId && event.eventName) {
              data[eventId] = {
                name: event.eventName,
                description: event.eventDescription || '',
                featuredFields: event.featuredFields || '',
                photo: event.eventPhoto || ''
              };
            }
          }
          return data;
        } catch (e) {
          console.warn('Failed to load events data:', e);
          return {};
        }
      }

      async function loadUsersData(){
        try {
          const response = await fetch('https://usaa-data-api.sebpartof2.workers.dev/api/users', {cache: 'no-store'});
          if (!response.ok) return {};
          const users = await response.json();
          const data = {};
          for (const user of users) {
            if (user.cid && user.displayName) {
              data[user.cid] = user.displayName;
            }
          }
          return data;
        } catch (e) {
          console.warn('Failed to load users data:', e);
          return {};
        }
      }

      async function loadArtccsData(){
        try {
          const response = await fetch('https://usaa-data-api.sebpartof2.workers.dev/api/artccs', {cache: 'no-store'});
          if (!response.ok) return {};
          const artccs = await response.json();
          const data = {};
          for (const artcc of artccs) {
            if (artcc.code && artcc.name) {
              data[artcc.code] = artcc.name;
            }
          }
          return data;
        } catch (e) {
          console.warn('Failed to load artccs data:', e);
          return {};
        }
      }

      async function loadAirportsData(){
        try {
          const response = await fetch('https://usaa-data-api.sebpartof2.workers.dev/api/airports', {cache: 'no-store'});
          if (!response.ok) return {};
          const airports = await response.json();
          const data = {};
          for (const airport of airports) {
            if (airport.facilityCode && airport.facilityName) {
              data[airport.facilityCode] = airport.facilityName;
            }
          }
          return data;
        } catch (e) {
          console.warn('Failed to load airports data:', e);
          return {};
        }
      }

      async function loadCallsignsData(){
        try {
          const response = await fetch('https://usaa-data-api.sebpartof2.workers.dev/api/callsigns', {cache: 'no-store'});
          if (!response.ok) return {};
          const callsigns = await response.json();
          const data = {};
          for (const cs of callsigns) {
            if (cs.callsign) {
              data[cs.callsign] = {
                airport: cs.airportFacility || '',
                fir: cs.artcc || '',
                frequency: cs.frequency || '',
                radioName: cs.radioName || ''
              };
            }
          }
          return data;
        } catch (e) {
          console.warn('Failed to load callsigns data:', e);
          return {};
        }
      }

      async function load(){
        refreshBtn.disabled = true;
        showMessage('Loading…', 'loading');
        listEl.innerHTML = '';
        
        // Load callsigns, airports, artccs, users, and events data in parallel
        if (Object.keys(callsignsData).length === 0) {
          const [callsigns, airports, artccs, users, events] = await Promise.all([
            loadCallsignsData(),
            loadAirportsData(),
            loadArtccsData(),
            loadUsersData(),
            loadEventsData()
          ]);
          callsignsData = callsigns;
          airportsData = airports;
          artccsData = artccs;
          usersData = users;
          eventsData = events;
        }
        try{
          // Fetch from USAA API
          const res = await fetch(UPSTREAM_URL, {cache: 'no-store'});
          if(!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
          const ctFinal = (res.headers.get('content-type') || '').toLowerCase();
          if(!ctFinal.includes('application/json')){
            throw new Error(`Unexpected content-type when fetching controllers: ${ctFinal}`);
          }
          const data = await res.json();

          const updated = data.timestamp || null;
          statusEl.textContent = updated ? `Updated: ${new Date(updated).toLocaleString()}` : 'Updated: —';

          const controllers = Array.isArray(data.data) ? data.data : [];

          // Build list of controllers for USAA
          window.__VATSIM_items = [];
          window.__VATSIM_artccs = {}; // map FIR code -> {code, displayName}
          for(const c of controllers){
            // USAA API: { cid, callsign, status, onlineTime, lastUpdate, firstSeen }
            const callsign = c.callsign || '';
            
            // Get enhanced data from callsigns.dat
            const enhancedData = callsignsData[callsign] || {};
            const airportCode = enhancedData.airport || '';
            const firCode = enhancedData.fir || '';
            const frequencyData = enhancedData.frequency || '';
            const radioNameFromFile = enhancedData.radioName || '';
            
            // Detect event positions (callsigns ending with _EVEN)
            const isEvent = callsign.endsWith('_EVEN');
            
            // For event positions, use event name from events.dat if available
            let finalRadioName = radioNameFromFile || callsign;
            let eventDescription = '';
            let featuredFields = '';
            let eventPhoto = '';
            if (isEvent) {
              // Extract event ID from callsign (everything before _EVEN)
              const eventId = callsign.replace('_EVEN', '');
              if (eventsData[eventId]) {
                finalRadioName = eventsData[eventId].name || eventsData[eventId];
                eventDescription = eventsData[eventId].description || '';
                featuredFields = eventsData[eventId].featuredFields || '';
                eventPhoto = eventsData[eventId].photo || '';
              }
            }
            
            const radioName = finalRadioName;
            const facilityName = airportCode || '';
            const frequency = frequencyData ? String(frequencyData) : null;
            const realName = '';
            const requestedRating = '';
            const isObserver = false;
            
            // Use FIR code as artccId, fallback to callsign prefix
            const artccId = firCode || callsign.split('_')[0] || '';
            
            window.__VATSIM_items.push({
              callsign, 
              facilityName, 
              radioName, 
              frequency, 
              realName, 
              requestedRating, 
              isObserver, 
              artccId, 
              airportCode,
              firCode,
              cid: c.cid || '',
              onlineTime: c.onlineTime || '',
              isEvent,
              eventDescription,
              featuredFields,
              eventPhoto,
              vatsimData: {}
            });
            
            if(artccId && !window.__VATSIM_artccs[artccId]){
              window.__VATSIM_artccs[artccId] = {
                code: artccId,
                displayName: (artccsData[firCode] || (firCode ? `${firCode}` : `${artccId} ARTCC`))
              };
            }
          }

          if(window.__VATSIM_items.length === 0){
            showMessage('No controllers online.', 'muted');
          } else {
            showMessage('', '');
            const artccEntries = Object.values(window.__VATSIM_artccs).sort((a,b)=>a.code.localeCompare(b.code));
            // try to load artccs.json (editable config)
            let cfgList = null;
            // Load overrides (optional) - mapping of callsign -> abbreviation
            let overrides = {};
            try{
              const cfgRes = await fetch('/artccs.json');
              if(cfgRes.ok){
                const cfg = await cfgRes.json();
                if(Array.isArray(cfg) && cfg.length){
                  // preserve aliases if present (optional `aliases` array)
                  cfgList = cfg.map(x=>({code:x.code,name:x.name, aliases: Array.isArray(x.aliases) ? x.aliases : []}));
                }
              }
            }catch(e){ /* ignore and fallback */ }

            try{
              const ovRes = await fetch('/overrides.json');
              if(ovRes.ok){
                const ov = await ovRes.json();
                if(ov && typeof ov.overrides === 'object'){
                  // normalize keys to uppercase for case-insensitive lookup
                  for(const k of Object.keys(ov.overrides)){
                    overrides[k.toUpperCase()] = ov.overrides[k];
                  }
                }
              }
            }catch(e){ /* ignore */ }

            const tilesList = cfgList || artccEntries.map(a=>({code:a.code,name:a.displayName, aliases: []}));
            function renderArtccTiles(list){
              const container = document.getElementById('artccTiles');
              container.innerHTML = '';
              // add an ALL tile
              const allBtn = document.createElement('button');
              allBtn.textContent = 'ALL';
              allBtn.dataset.code = 'ALL';
              styleTile(allBtn);
              allBtn.addEventListener('click', ()=>{
                document.getElementById('artccTitle').textContent = 'United States NAS';
                renderItems(window.__VATSIM_items);
                Array.from(container.children).forEach(c=>c.style.opacity = '0.6');
                allBtn.style.opacity = '1';
              });
              container.appendChild(allBtn);

              for(const a of list){
                const btn = document.createElement('button');
                // show only the code on the tile
                btn.textContent = a.code;
                btn.dataset.code = a.code;
                styleTile(btn);
                btn.addEventListener('click', ()=>{
                  // set title using config name + code
                  document.getElementById('artccTitle').textContent = `${a.name} - ${a.code}`;
                  // support filtering by primary code OR any aliases provided in the config
                  // also support filtering by sector prefix (e.g., KWEST matches KWEST-PHZH)
                  const codes = [a.code].concat(Array.isArray(a.aliases) ? a.aliases : []);
                  const matching = window.__VATSIM_items.filter(i=> {
                    // Exact match
                    if (codes.includes(i.artccId)) return true;
                    // Prefix match (e.g., KWEST matches KWEST-PHZH)
                    return codes.some(code => i.artccId && i.artccId.startsWith(code + '-'));
                  });
                  renderItems(matching);
                  // visually mark selected
                  Array.from(container.children).forEach(c=>c.style.opacity = '0.6');
                  btn.style.opacity = '1';
                });
                container.appendChild(btn);
              }
            }

            function styleTile(btn){
              btn.style.background = 'white';
              btn.style.border = '1px solid rgba(10,49,97,0.2)';
              btn.style.color = '#0A3161';
              btn.style.padding = '8px 16px';
              btn.style.borderRadius = '6px';
              btn.style.cursor = 'pointer';
              btn.style.opacity = '0.7';
              btn.style.fontWeight = '500';
              btn.style.fontSize = '14px';
              btn.style.transition = 'all 0.3s ease';
            }

            renderArtccTiles(tilesList);
            // set default title to United States NAS and mark ALL
            document.getElementById('artccTitle').textContent = 'United States NAS';
            // set all opacity
            const container = document.getElementById('artccTiles');
            if(container && container.firstChild) Array.from(container.children).forEach(c=>c.style.opacity='0.6');
            if(container && container.firstChild) container.firstChild.style.opacity = '1';

            // sort alphabetically by callsign
            window.__VATSIM_items.sort((a,b)=>a.callsign.localeCompare(b.callsign));
            function renderItems(itemsToRender){
              listEl.innerHTML = '';
              const events = [];
              const normal = [];
              const observers = [];
              for(const it of itemsToRender){
                // resolve abbreviation: first check overrides by callsign (case-insensitive), then feed
                let roleAbbr = '';
                let roleSource = '';
                try{
                  const csKey = (it.callsign || '').toUpperCase();
                  if(csKey && overrides[csKey]){
                    roleAbbr = String(overrides[csKey]).toUpperCase();
                    roleSource = 'override';
                  } else {
                    for(const ok of Object.keys(overrides)){
                      if(!ok) continue;
                      if(csKey.startsWith(ok) || csKey.endsWith(ok) || csKey.includes(ok)){
                        roleAbbr = String(overrides[ok]).toUpperCase();
                        roleSource = 'override';
                        break;
                      }
                      const tokens = csKey.split(/[-_\/\s]/).map(t=>t.trim()).filter(Boolean);
                      if(tokens.includes(ok)){
                        roleAbbr = String(overrides[ok]).toUpperCase();
                        roleSource = 'override';
                        break;
                      }
                    }
                  }
                  if(!roleAbbr && it.requestedRating){
                    roleAbbr = String(it.requestedRating).toUpperCase();
                    roleSource = 'feed';
                  }
                }catch(e){ roleAbbr = ''; }

                // Separate into events, normal, and observers
                const roleNorm = (roleAbbr || '').toString().toUpperCase().trim();
                if(it.isEvent){
                  events.push({it, roleAbbr: roleNorm, roleSource});
                } else if(it.isObserver){
                  observers.push({it, roleAbbr: roleNorm, roleSource});
                } else {
                  normal.push({it, roleAbbr: roleNorm, roleSource});
                }
              }

              function buildLi(itemObj){
                const {it, roleAbbr, roleSource} = itemObj;
                const li = document.createElement('li');
                li.className = 'item';
                
                let contentWrapper = null;
                let left, right;
                
                // For event positions, structure differently
                if (it.isEvent) {
                  // Add event image at the top
                  if (it.eventPhoto) {
                    const eventImg = document.createElement('img');
                    eventImg.src = it.eventPhoto;
                    eventImg.className = 'event-image';
                    eventImg.alt = 'Event Photo';
                    
                    // Add error handling for failed image loads
                    eventImg.onerror = function() {
                      console.warn('Failed to load event image:', it.eventPhoto);
                      this.style.display = 'none';
                      this.style.marginBottom = '0';
                    };
                    
                    // Add load success logging
                    eventImg.onload = function() {
                      console.log('Successfully loaded event image:', it.eventPhoto);
                    };
                    
                    li.appendChild(eventImg);
                  }
                  
                  // Content wrapper for text below image
                  contentWrapper = document.createElement('div');
                  contentWrapper.className = 'event-content';
                }
                
                // Create left and right divs for both event and regular items
                left = document.createElement('div'); left.className = 'left';
                  const radio = document.createElement('div'); radio.className = 'radio'; radio.textContent = it.radioName || '';
                  const facility = document.createElement('div'); facility.className = 'facility';
                  // Format as 'Airport Name (CODE)' if airport name is available
                  if (it.airportCode && airportsData[it.airportCode]) {
                    facility.textContent = `${airportsData[it.airportCode]} (${it.airportCode})`;
                  } else if (it.airportCode) {
                    facility.textContent = it.airportCode;
                  }
                  const firDiv = document.createElement('div'); firDiv.className = 'facility';
                  // Format as 'FIR Name (CODE)' if FIR name is available
                  if (it.firCode && artccsData[it.firCode]) {
                    firDiv.textContent = `${artccsData[it.firCode]} (${it.firCode})`;
                  } else if (it.firCode) {
                    firDiv.textContent = it.firCode;
                  }
                  const cidDiv = document.createElement('div'); cidDiv.className = 'facility';
                  
                  // Add event description above CID for event positions
                  const eventDescDiv = document.createElement('div'); eventDescDiv.className = 'facility';
                  if (it.isEvent && it.eventDescription) {
                    eventDescDiv.textContent = it.eventDescription;
                    eventDescDiv.style.fontStyle = 'italic';
                    eventDescDiv.style.color = 'white';
                  }
                  
                  // Use display name from users.dat if available, otherwise show CID
                  if (it.cid && usersData[it.cid]) {
                    cidDiv.textContent = usersData[it.cid];
                  } else if (it.cid) {
                    cidDiv.textContent = it.cid;
                  }
                  const real = document.createElement('div'); real.className = 'realname'; real.textContent = it.realName || '';
                   // Create online time badge
                  const onlineBadge = document.createElement('span'); onlineBadge.className = 'role-badge';
                  if (it.onlineTime) {
                    const onlineDate = new Date(it.onlineTime);
                    const now = new Date();
                    const diffMs = now - onlineDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const hours = Math.floor(diffMins / 60);
                    const minutes = diffMins % 60;
                    onlineBadge.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                  }
                  const infoText = (it.vatsimData && typeof it.vatsimData.controllerInfo === 'string') ? it.vatsimData.controllerInfo : '';
                  if(infoText) {
                    const infoIcon = document.createElement('span');
                    infoIcon.textContent = 'ℹ️';
                    infoIcon.style.cursor = 'pointer';
                    infoIcon.style.marginLeft = '6px';
                    infoIcon.style.fontSize = '14px';
                    infoIcon.style.position = 'relative';

                    // Custom tooltip
                    const tooltip = document.createElement('div');

                    // Auto-link URLs in infoText
                    function linkify(text) {
                      const urlRegex = /(https?:\/\/[^\s]+)/g;
                      return text.replace(urlRegex, function(url) {
                        return '<a href="' + url + '" target="_blank" rel="noopener noreferrer" style="color:#9fc3ff;text-decoration:underline">' + url + '</a>';
                      });
                    }
                    tooltip.innerHTML = linkify(infoText).replace(/\n/g, '<br>');
                    tooltip.style.position = 'absolute';
                    tooltip.style.left = '20px';
                    tooltip.style.top = '0';
                    tooltip.style.background = '#222e44';
                    tooltip.style.color = '#cfe4ff';
                    tooltip.style.padding = '8px 12px';
                    tooltip.style.borderRadius = '8px';
                    tooltip.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
                    tooltip.style.fontSize = '13px';
                    tooltip.style.zIndex = '100';
                    tooltip.style.whiteSpace = 'pre-line';
                    tooltip.style.display = 'none';

                    infoIcon.addEventListener('mouseenter', () => {
                      tooltip.style.display = 'block';
                    });
                    infoIcon.addEventListener('mouseleave', () => {
                      tooltip.style.display = 'none';
                    });
                    infoIcon.appendChild(tooltip);

                    // Add the icon next to the real name
                    if(real.textContent) {
                      real.appendChild(infoIcon);
                    } else {
                      left.appendChild(infoIcon);
                    }
                  }
                  // create role badge
                  const roleBadge = document.createElement('span'); roleBadge.className = 'role-badge'; roleBadge.textContent = roleAbbr || '';
                  if(roleSource) roleBadge.title = roleSource === 'override' ? 'override' : 'feed';
                  
                  // Add online time badge to radio name if available
                  if(onlineBadge.textContent){
                    radio.appendChild(onlineBadge);
                  }
                right = document.createElement('div'); right.className = 'right';
                const freq = document.createElement('div'); freq.className = 'freq';
                if(it.isEvent && it.featuredFields){
                  // For events, show featured fields instead of frequency
                  freq.textContent = it.featuredFields;
                } else if(it.frequency){
                  // For regular positions, show frequency without MHz
                  freq.textContent = it.frequency;
                } else {
                  freq.textContent = '';
                }
                left.appendChild(radio);
                if(facility.textContent) left.appendChild(facility);
                if(firDiv.textContent) left.appendChild(firDiv);
                if(eventDescDiv.textContent) left.appendChild(eventDescDiv);
                if(cidDiv.textContent) left.appendChild(cidDiv);
                if(real.textContent) left.appendChild(real);
                right.appendChild(freq);
                const csSmall = document.createElement('div'); csSmall.className = 'callsign-small'; csSmall.textContent = it.callsign || '';
                if(csSmall.textContent) right.appendChild(csSmall);
                if(roleBadge.textContent){
                  if(real.textContent){
                    if(!real.contains(roleBadge)) real.appendChild(roleBadge);
                  } else {
                    roleBadge.style.marginTop = '6px';
                    right.appendChild(roleBadge);
                  }
                }
                
                if (it.isEvent) {
                  // For events, add left and right to content wrapper, then wrapper to li
                  contentWrapper.appendChild(left);
                  contentWrapper.appendChild(right);
                  li.appendChild(contentWrapper);
                } else {
                  // For regular items, add left and right directly to li
                  li.appendChild(left);
                  li.appendChild(right);
                }
                
                return li;
              }

              // render events first (pinned to top)
              for(const o of events){
                const li = buildLi(o);
                li.classList.add('event');
                listEl.appendChild(li);
              }
              
              // render normal items
              for(const o of normal){
                listEl.appendChild(buildLi(o));
              }
              // then render observers with muted italic styling
              for(const o of observers){
                const li = buildLi(o);
                li.classList.add('observer');
                listEl.appendChild(li);
              }
            }

            // initial render = all items
            renderItems(window.__VATSIM_items);
            // hook filter change is handled by ARTCC tiles now
            const artccTitle = document.getElementById('artccTitle');
          }

        }catch(err){
          console.error(err);
          // CORS and network errors are common when opening locally — show helpful hint
          const isCors = /(CORS|cross-origin)/i.test(err.message) || err instanceof TypeError;
          showMessage(isCors ? 'Could not fetch data (possible CORS or network issue). Try serving this page via a local HTTP server or use a proxy. See console for details.' : `Error: ${err.message}`, 'error');
        } finally {
          refreshBtn.disabled = false;
        }
      }

      refreshBtn.addEventListener('click', ()=> load());
      // initial load
      load();
    </script>
    <!-- Overrides editor removed per user request -->
  </body>
</html>
